<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>Asianloop ‚Äî Marketing & Business Dev Form</title>

  <!-- Favicon & CSS -->
  <link rel="icon" href="./public/favicon.ico" />
  <!-- Cache-bust query to avoid Safari/GitHub Pages caching old CSS -->
  <link rel="stylesheet" href="public/css/styles.css?v=4" />

  <style>
    /* Inline fallback so it never appears ‚Äúunstyled‚Äù while CSS caches */
    body{margin:0;font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#0f172a;background:#fff}
    .al-inner{max-width:1040px;margin:0 auto;padding:0 16px}
    .brand-logo{height:32px}
    .card{border:1px solid #e5e7eb;border-radius:14px;padding:16px;margin:16px 0}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:860px){.grid-2{grid-template-columns:1fr}}
    .steps{display:flex;flex-wrap:wrap;gap:6px;margin:12px 0}
    .steps .step{border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;background:#f8fafc;cursor:pointer}
    .steps .is-active{background:#eef0ff;border-color:#5b5bd6;color:#3f3fb3}
    .field{display:flex;flex-direction:column;gap:6px}
    .field span{font-weight:600;font-size:13px;color:#6b7280}
    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
    .btn{border:1px solid #e5e7eb;border-radius:10px;padding:9px 12px;background:linear-gradient(180deg,#fff,#f8fafc);font-weight:700;cursor:pointer}
    .step-pane{display:none}.step-pane.is-active{display:block}
  </style>
</head>
<body>
  <header class="al-header">
    <div class="al-inner header-row">
      <div class="brand-left">
        <img src="./public/logo-light.png" alt="Asianloop" class="brand-logo" />
        <div class="brand-text">

          <h1>Marketing &amp; Business Dev Form</h1>
        </div>
      </div>
      <div class="brand-right">
        <div class="avatar" title="Logged-in user">AL</div>
      </div>
    </div>
  </header>

  <main class="al-main al-inner">
    <!-- Sticky stepper -->
    <nav id="steps" class="steps sticky-steps">
      <button class="step is-active" data-step="1">1. Staff &amp; Visit</button>
      <button class="step" data-step="2">2. Client</button>
      <button class="step" data-step="3">3. Opportunity</button>
      <button class="step" data-step="4">4. Tech</button>
      <button class="step" data-step="5">5. Timeline</button>
      <button class="step" data-step="6">6. Attach &amp; Notes</button>
      <button class="step" data-step="7">7. Review</button>
    </nav>

    <form id="al-form" class="al-form" autocomplete="on">
      <!-- 1) Staff & Visit -->
      <section class="card step-pane is-active" data-step-pane="1">
        <h2>Staff &amp; Visit</h2>
        <div class="grid-2">
          <label class="field">
            <span>Staff ID</span>
            <input name="staff.unitId" placeholder="S001" />
          </label>
          <label class="field">
            <span>Staff Name</span>
            <input name="staff.name" placeholder="Your name" />
          </label>
          <label class="field">
            <span>Date of Meeting</span>
            <input type="date" name="staff.meetingDate" />
          </label>
          <label class="field">
            <span>Visit Type</span>
            <select name="staff.visitType">
              <option value="">Select‚Ä¶</option>
              <option>In-person</option>
              <option>Virtual</option>
              <option>Phone</option>
              <option>Casual</option>
              <option>Others</option>
            </select>
          </label>
        </div>

        <div class="grid-2">
  <label class="field">
    <span>Area</span>
    <select name="staff.region.area" id="areaSelect">
      <option value="">Select‚Ä¶</option>
      <option>Local</option>
      <option>International</option>
    </select>
  </label>

  <div class="grid-2 tight-cols">
    <!-- Local -->
    <label class="field" id="localRegionWrap">
      <span>Local Region</span>
      <select name="staff.region.local" id="localRegion">
        <option value="">Select‚Ä¶</option>
        <option>Northern</option>
        <option>Southern</option>
        <option>East Coast</option>
        <option>West Malaysia</option>
        <option>Borneo (Sabah/Sarawak)</option>
      </select>
    </label>

    <!-- International -->
    <label class="field" id="intlRegionWrap">
      <span>International Region</span>
      <select name="staff.region.international" id="intlRegion">
        <option value="">Select‚Ä¶</option>
        <option>ASEAN</option>
        <option>Middle East</option>
        <option>China</option>
        <option>Russia</option>
        <option>Europe</option>
        <option>North America</option>
      </select>
    </label>

    <!-- Country/City for International -->
    <label class="field" id="intlCountryWrap">
      <span>Country</span>
      <input name="staff.region.country" id="intlCountry" placeholder="e.g., Indonesia" />
    </label>
    <label class="field" id="intlCityWrap">
      <span>City</span>
      <input name="staff.region.city" id="intlCity" placeholder="e.g., Jakarta" />
    </label>
  </div>
</div>


        <div class="actions">
          <button type="button" class="btn next">Next</button>
        </div>
      </section>

      <!-- 2) Client -->
      <section class="card step-pane" data-step-pane="2">
        <h2>Client</h2>
        <div class="grid-2">
          <label class="field">
            <span>Company</span>
            <input name="client.company" list="companyList" placeholder="Start typing‚Ä¶" />
            <datalist id="companyList">
              <option value="PETRONAS Carigali (PMA)">
              <option value="PETRONAS Gas Berhad (PGB)">
              <option value="MRCSB">
              <option value="Shell Malaysia">
              <option value="ExxonMobil Malaysia">
            </datalist>
          </label>
          <label class="field">
            <span>Customer Representative</span>
            <input name="client.rep" placeholder="Person you met" />
          </label>
          <label class="field">
            <span>Position/Role</span>
            <input name="client.position" placeholder="e.g., Maintenance Manager" />
          </label>
          <label class="field">
            <span>Email</span>
            <input type="email" name="client.email" placeholder="name@company.com" />
          </label>
          <label class="field">
            <span>Phone / WhatsApp</span>
            <input name="client.phone" placeholder="+60‚Ä¶" />
          </label>
          <label class="field">
            <span>Industry</span>
            <select name="client.industry">
              <option value="">Select‚Ä¶</option>
              <option>O&amp;G</option>
              <option>GI</option>
              <option>Chemical</option>
              <option>Utility</option>
              <option>Other</option>
            </select>
          </label>
        </div>
        <label class="field">
          <span>Address / Site (optional)</span>
          <input name="client.address" placeholder="Site/location" />
        </label>

        <div class="actions">
          <button type="button" class="btn ghost prev">Back</button>
          <button type="button" class="btn next">Next</button>
        </div>
      </section>

      <!-- 3) Opportunity -->
      <section class="card step-pane" data-step-pane="3">
        <h2>Opportunity</h2>
        <div class="grid-2">
          <label class="field">
            <span>Priority</span>
            <select name="opportunity.priority" id="prioritySelect">
              <option value="">Select‚Ä¶</option>
              <option value="1">P1 (Highest)</option>
              <option value="2">P2</option>
              <option value="3">P3</option>
              <option value="4">P4</option>
              <option value="5">P5</option>
            </select>
          </label>
          <label class="field">
            <span>Stage</span>
            <select name="opportunity.stage">
              <option value="">Select‚Ä¶</option>
              <option>Lead</option>
              <option>Qualified</option>
              <option>Proposal</option>
              <option>Negotiation</option>
              <option>Won</option>
              <option>Lost</option>
            </select>
          </label>
        </div>

        <div class="grid-2">
          <label class="field">
            <span>Estimated Budget</span>
            <input type="number" step="0.01" name="opportunity.budget" placeholder="Amount (MYR)" />
          </label>
          <label class="field">
            <span>Decision Maker Identified?</span>
              <select name="opportunity.decisionMaker" id="decisionMakerSelect">
              <option value="">Select‚Ä¶</option>
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </label>
        </div>

<label class="field hidden" id="dmNameWrap">
  <span>Decision Maker (Name/Role)</span>
  <input name="opportunity.decisionMakerName" id="dmNameInput" placeholder="e.g., GM Operations ‚Äî Ali Bin Ahmad" disabled />
</label>
        
        <label class="field">
          <span>Procurement Route</span>
          <select name="opportunity.procurement">
            <option value="">Select‚Ä¶</option>
            <option>Direct</option>
            <option>Tender</option>
            <option>Agent/Authorized Dealer</option>
            <option>Umbrealla Contract</option>
            <option>This Year Planning</option>
            <option>Next Year Planning</option>
          </select>
        </label>

        <label class="field">
          <span>Products / Services Interest</span>
          <select name="opportunity.interests" id="interests" multiple size="6">
            <option>Flow calibration</option>
            <option>Custody metering</option>
            <option>Provers</option>
            <option>Analyzer services</option>
            <option>Training</option>
            <option>Compliance (API/OIML/ISO)</option>
            <option>Maintenance contracts</option>
            <option>Others</option>
          </select>
          <small class="hint">Use Ctrl/‚åò + click to multi-select.</small>
        </label>

        <label class="field hidden" id="interestsOtherWrap">
  <span>Please specify other products/services</span>
  <input name="opportunity.interestsOther" id="interestsOtherInput" placeholder="Describe other interest‚Ä¶" disabled />
</label>

        <label class="field">
          <span>Standards / Compliance</span>
          <select name="opportunity.standards" id="standards" multiple size="6">
            <option>API MPMS 5.x</option>
            <option>API MPMS 21.1</option>
            <option>OIML R-117</option>
            <option>ISO 17025</option>
            <option>SIRIM</option>
            <option>DOE CAR2014</option>
            <option>BOMBA</option>
            <option>AELB</option>
          </select>
          <small class="hint">Use Ctrl/‚åò + click to multi-select.</small>
        </label>

        <div class="actions">
          <button type="button" class="btn ghost prev">Back</button>
          <button type="button" class="btn next">Next</button>
        </div>
      </section>

      <!-- 4) Tech -->
      <section class="card step-pane" data-step-pane="4">
        <h2>Tech Details (Optional)</h2>
        <!-- Meters at site (repeater) -->
<div class="card-sub">
  <div class="meters-head">
    <h3>Meters at Site</h3>
    <button type="button" class="btn small" id="addMeterBtn">+ Add Meter</button>
  </div>

  <div id="metersList" class="meters-list"></div>
  <input type="hidden" name="tech.metersJson" id="metersJson" value="[]"/>
  <small class="hint">Add each meter the client wants us to consider. Choose ‚ÄúCustom‚Ä¶‚Äù to type your own.</small>
</div>

<!-- Operating conditions (overall) -->
<label class="field">
  <span>Operating Conditions (overall)</span>
  <input name="tech.conditions" placeholder="Pressure, temperature‚Ä¶" />
</label>


        <label class="field">
          <span>Current Measurement Issues</span>
          <textarea name="tech.issues" rows="3" placeholder="Drift, repeatability, prover availability‚Ä¶"></textarea>
        </label>
        <label class="field">
          <span>Required Certs / Docs</span>
          <input name="tech.requiredDocs" placeholder="ISO17025 CoC, As-Found/As-Left, TP/LP‚Ä¶" />
        </label>

        <div class="actions">
          <button type="button" class="btn ghost prev">Back</button>
          <button type="button" class="btn next">Next</button>
        </div>
      </section>

      <!-- 5) Timeline -->
      <section class="card step-pane" data-step-pane="5">
        <h2>Timeline &amp; Next Actions</h2>
        <div class="grid-2">
          <label class="field">
            <span>Expected Timeline</span>
            <input name="timeline.expected" placeholder="e.g., 2025-Q4 or Nov 2025" />
          </label>
          <label class="field">
            <span>Next Follow-Up Date</span>
            <input type="date" name="timeline.nextFollowUp" />
          </label>
          <label class="field">
            <span>Follow-Up Status</span>
            <select name="timeline.followUpStatus">
              <option value="">Select‚Ä¶</option>
              <option>Pending</option>
              <option>Done</option>
              <option>Rescheduled</option>
            </select>
          </label>
          <label class="field">
            <span>PIC</span>
            <input name="timeline.owner" placeholder="Defaults to submitter later" />
          </label>
        </div>

        <label class="field">
          <span>Task (optional)</span>
          <input name="timeline.task1" placeholder="e.g., Send capability deck ‚Äî 28 Sep" />
        </label>

        <div class="actions">
          <button type="button" class="btn ghost prev">Back</button>
          <button type="button" class="btn next">Next</button>
        </div>
      </section>

      <!-- 6) Attach + Notes -->
      <section class="card step-pane" data-step-pane="6">
        <h2>Attachments &amp; Notes</h2>

<div class="grid-2">
  <label class="field">
    <span>Photos</span>
    <input type="file" id="filePhotos" accept="image/*" multiple />
    <small class="hint">Images only (stored locally until backend is wired).</small>
  </label>
  <label class="field">
    <span>Document (PDF)</span>
    <input type="file" id="fileDocs" accept="application/pdf" multiple />
    <small class="hint">PDF only (stored locally until backend is wired).</small>
  </label>
</div>

<div class="media-wrap">
  <div>
    <h4 class="media-title">Photo Gallery</h4>
    <div id="photosList" class="photos-grid"></div>
  </div>
  <div>
    <h4 class="media-title">Documents</h4>
    <ul id="docsList" class="docs-list"></ul>
  </div>
</div>

<input type="hidden" id="photosJson" name="attachments.photosJson" value="[]"/>
<input type="hidden" id="docsJson" name="attachments.docsJson" value="[]"/>

<label class="field">
  <span>Internal Notes</span>
  <textarea name="notes" rows="4" placeholder="Context for manager (internal only)‚Ä¶"></textarea>
</label>

<div class="actions">
  <button type="button" class="btn ghost prev">Back</button>
  <button type="button" class="btn next">Next</button>
</div>

      </section>

      <!-- 7) Review -->
      <section class="card step-pane" data-step-pane="7">
        <h2>Review &amp; Submit</h2>
        <div id="review" class="review"></div>

        <label class="consent">
          <input type="checkbox" id="consentChk" />
          <span>I confirm the information provided is accurate to the best of my knowledge.</span>
        </label>

        <div class="actions">
          <button type="button" class="btn ghost prev">Back</button>
          <button type="button" class="btn" id="printBtn">Print Summary</button>
          <button type="submit" class="btn primary" id="submitBtn" disabled>Submit</button>
          <button type="button" class="btn danger" id="resetBtn">Reset</button>
        </div>
      </section>
    </form>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <footer class="al-footer">
    <div class="al-inner">
      <small>¬© <span id="year"></span> Asianloop ‚Äî Internal use for Marketing &amp; Business Dev</small>
    </div>
  </footer>

  <script>
    const $ = (q, ctx=document) => ctx.querySelector(q);
    const $$ = (q, ctx=document) => Array.from(ctx.querySelectorAll(q));
    const STORAGE_KEY = 'albusinessforms.draft';

   function showToast(msg) {
  const t = $('#toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => {
    t.classList.remove('show');
    t.textContent = ''; // clear so no text lingers
  }, 1800);
}

    function objSet(o,p,v){ const a=p.split('.'); let c=o; for(let i=0;i<a.length-1;i++){ if(!(a[i] in c)) c[a[i]]={}; c=c[a[i]];} c[a[a.length-1]]=v; }
    function serializeForm(form){
      const d={}; $$('input,select,textarea',form).forEach(el=>{
        if(!el.name) return;
        if(el.type==='checkbox'){ objSet(d,el.name||el.id,el.checked); }
        else if(el.multiple && el.options){ objSet(d,el.name, Array.from(el.options).filter(o=>o.selected).map(o=>o.value)); }
        else { objSet(d,el.name,el.value); }
      }); return d;
    }
    function fillForm(form,data){
      if(!data) return;
      $$('input,select,textarea',form).forEach(el=>{
        const path=el.name||el.id; if(!path) return;
        const parts=path.split('.'); let cur=data;
        for(const p of parts){ if(cur && typeof cur==='object' && p in cur){ cur=cur[p]; } else { cur=undefined; break; } }
        if(cur===undefined) return;
        if(el.type==='checkbox'){ el.checked=!!cur; }
        else if(el.multiple && Array.isArray(cur)){ Array.from(el.options).forEach(o=>o.selected=cur.includes(o.value)); }
        else { el.value=cur; }
      });
    }
function saveDraft(){
  updateMetersJson();      // meters
  updatePhotosJson();      // photos
  updateDocsJson();        // docs
  const d = serializeForm($('#al-form'));
  localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
  $('#submitBtn').disabled = !$('#consentChk').checked;
}

    function loadDraft(){ const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return; try{ const d=JSON.parse(raw); fillForm($('#al-form'),d); showToast('Draft loaded'); updateAreaVisibility(); hydrateMediaFromHidden();
 }catch{} }
    function clearDraft(){ localStorage.removeItem(STORAGE_KEY); }

    function priorityTag(p){
      const cls={1:'p1',2:'p2',3:'p3',4:'p4',5:'p5'}[p]||'p5';
      const label={1:'P1',2:'P2',3:'P3',4:'P4',5:'P5'}[p]||'P?';
      return `<span class="priority ${cls}">${label}</span>`;
    }
   function buildReview(){
  const d = serializeForm($('#al-form'));
  const interests = (d.opportunity?.interests || []).join(', ') || '‚Äî';
  const standards = (d.opportunity?.standards || []).join(', ') || '‚Äî';
  const dm = d.opportunity?.decisionMaker === 'true' ? 'Yes' :
             d.opportunity?.decisionMaker === 'false' ? 'No' : '‚Äî';

  let metersArr = [];
  try { metersArr = JSON.parse(d.tech?.metersJson || '[]'); } catch {}
const metersHtml = (metersArr.length
  ? `<ol class="meters-review">` + metersArr.map(m => {
      const tag = m.tag ? `<strong>${String(m.tag).replace(/</g,'&lt;')}</strong> ‚Äî ` : '';
      return `<li>${tag}${(m.type || '‚Äî')} ‚Äî ${m.sizeIn ?? '‚Äî'} in ‚Äî ${m.medium || '‚Äî'}</li>`;
    }).join('') + `</ol>`
  : '‚Äî');


  $('#review').innerHTML = `
    <div class="review-grid">
      <div>
        <h3>Staff & Visit</h3>
        <ul>
          <li><strong>Staff ID:</strong> ${d.staff?.unitId || '‚Äî'}</li>
          <li><strong>Staff:</strong> ${d.staff?.name || '‚Äî'}</li>
          <li><strong>Date:</strong> ${d.staff?.meetingDate || '‚Äî'}</li>
          <li><strong>Visit Type:</strong> ${d.staff?.visitType || '‚Äî'}</li>
          <li><strong>Area:</strong> ${d.staff?.region?.area || '‚Äî'}</li>
          <li><strong>Local:</strong> ${d.staff?.region?.local || '‚Äî'}</li>
          <li><strong>International:</strong> ${d.staff?.region?.international || '‚Äî'}</li>
        </ul>
      </div>
      <div>
        <h3>Client</h3>
        <ul>
          <li><strong>Company:</strong> ${d.client?.company || '‚Äî'}</li>
          <li><strong>Rep:</strong> ${d.client?.rep || '‚Äî'}</li>
          <li><strong>Position:</strong> ${d.client?.position || '‚Äî'}</li>
          <li><strong>Email:</strong> ${d.client?.email || '‚Äî'}</li>
          <li><strong>Phone:</strong> ${d.client?.phone || '‚Äî'}</li>
          <li><strong>Industry:</strong> ${d.client?.industry || '‚Äî'}</li>
          <li><strong>Address:</strong> ${d.client?.address || '‚Äî'}</li>
        </ul>
      </div>
      <div>P
        <h3>Opportunity ${priorityTag(d.opportunity?.priority || '')}</h3>
        <ul>
          <li><strong>Stage:</strong> ${d.opportunity?.stage || '‚Äî'}</li>
          <li><strong>Budget:</strong> ${d.opportunity?.budget || '‚Äî'}</li>
          <li><strong>Decision Maker:</strong> ${dm}</li>
          <li><strong>Procurement:</strong> ${d.opportunity?.procurement || '‚Äî'}</li>
          <li><strong>Interests:</strong> ${interests}</li>
          <li><strong>Standards:</strong> ${standards}</li>
        </ul>
      </div>
     <div>
  <h3>Tech</h3>
  <ul>
    <li><strong>Meters:</strong> ${metersHtml}</li>
    <li><strong>Conditions:</strong> ${d.tech?.conditions || '‚Äî'}</li>
    <li><strong>Issues:</strong> ${d.tech?.issues || '‚Äî'}</li>
    <li><strong>Required Docs:</strong> ${d.tech?.requiredDocs || '‚Äî'}</li>
  </ul>

 <h3 style="margin-top:10px">Photos</h3>
${(_photos && _photos.length)
  ? `<div class="photos-grid review-photos">` + _photos.map((p, i) =>
      `<figure class="photo-card">
         <img class="photo-thumb" src="${p.dataUrl}" alt="Photo ${i+1}">
         <figcaption class="photo-caption">
           <div class="photo-caption-title">${(p.desc || 'No description').replace(/</g,'&lt;')}</div>
           <div class="photo-caption-meta">${(p.name || '').replace(/</g,'&lt;')}</div>
         </figcaption>
       </figure>`
    ).join('') + `</div>`
  : '<div class="hint">‚Äî</div>'}


  <h3 style="margin-top:10px">Documents (PDF)</h3>
  ${(_docs && _docs.length)
      ? `<ul class="docs-list">` + _docs.map(d => `<li class="doc-item"><span class="doc-name">üìÑ ${d.name}</span></li>`).join('') + `</ul>
         <small class="hint">PDFs will print as an appendix after the summary.</small>`
      : '<div class="hint">‚Äî</div>'}
</div>

<div>
  <h3>Notes</h3>
  <div class="notes-box">${(d.notes || '').replace(/</g,'&lt;') || '‚Äî'}</div>
</div>

    </div>`;
}

function updateAreaVisibility(){
  const val = $('#areaSelect').value;
  const localSel   = $('#localRegion');
  const intlSel    = $('#intlRegion');
  const countryInp = $('#intlCountry');
  const cityInp    = $('#intlCity');

  if (val === 'Local') {
    localSel.disabled = false;
    intlSel.disabled = true;    intlSel.value = '';
    countryInp.disabled = true; countryInp.value = '';
    cityInp.disabled = true;    cityInp.value = '';
  } else if (val === 'International') {
    localSel.disabled = true;   localSel.value = '';
    intlSel.disabled = false;
    countryInp.disabled = false;
    cityInp.disabled = false;
  } else {
    // nothing chosen yet
    localSel.disabled = true;   intlSel.disabled = true;
    countryInp.disabled = true; cityInp.disabled = true;
  }
}


    /* --- Meters repeater --- */
function addMeterRow(values = {}) {
  const row = document.createElement('div');
  row.className = 'meter-row';
  row.innerHTML = `
    <div class="meter-col">
      <label class="field">
        <span>Type</span>
        <select class="meter-type">
          <option value="">Select‚Ä¶</option>
          <option>Ultrasonic</option>
          <option>Coriolis</option>
          <option>Turbine</option>
          <option>Positive Displacement</option>
          <option>Orifice</option>
          <option>Vortex</option>
          <option value="__custom__">Custom‚Ä¶</option>
        </select>
      </label>
      <input class="meter-type-custom hidden" placeholder="Custom type" />
    </div>

    <label class="field">
      <span>Size (in)</span>
      <input type="number" step="0.1" class="meter-size" placeholder="e.g., 12" />
    </label>

    <label class="field">
      <span>Medium</span>
      <select class="meter-medium">
        <option value="">Select‚Ä¶</option>
        <option>Crude</option>
        <option>Condensate</option>
        <option>NGL</option>
        <option>LNG</option>
        <option>Gas</option>
        <option>Water</option>
        <option>Chemical</option>
      </select>
    </label>

    <label class="field">
      <span>Tag Number</span>
      <input class="meter-tag" placeholder="e.g., FE-1234" />
    </label>

    <button type="button" class="btn icon danger remove-meter" title="Remove meter">‚úï</button>
  `;
  $('#metersList').appendChild(row);

  // Prefill if values provided
  const sel = row.querySelector('.meter-type');
  const custom = row.querySelector('.meter-type-custom');
  const size = row.querySelector('.meter-size');
  const medium = row.querySelector('.meter-medium');
  const tag = row.querySelector('.meter-tag');

  if (values.type) {
    const opts = Array.from(sel.options).map(o => o.value || o.textContent);
    if (opts.includes(values.type)) {
      sel.value = values.type;
    } else {
      sel.value = '__custom__';
      custom.classList.remove('hidden');
      custom.value = values.type;
    }
  }
  if (values.sizeIn != null) size.value = values.sizeIn;
  if (values.medium) medium.value = values.medium;
  if (values.tag) tag.value = values.tag;
}



function updateMetersJson(){
  const arr = [];
  $$('#metersList .meter-row').forEach(row => {
    const sel = row.querySelector('.meter-type');
    const custom = row.querySelector('.meter-type-custom');
    const size = row.querySelector('.meter-size');
    const medium = row.querySelector('.meter-medium');
    const tag = row.querySelector('.meter-tag');
    const type = sel.value === '__custom__' ? (custom.value || '').trim() : sel.value;
    const sizeIn = size.value ? Number(size.value) : null;
    const med = medium.value;
    const tg = (tag.value || '').trim();
    if ((type && type !== '') || sizeIn !== null || med || tg) {
      arr.push({ type, sizeIn, medium: med, tag: tg });
    }
  });
  $('#metersJson').value = JSON.stringify(arr);
}


function buildMetersUIFromHidden(){
  const raw = $('#metersJson').value || '[]';
  let data = [];
  try { data = JSON.parse(raw); } catch {}
  $('#metersList').innerHTML = '';
  if (Array.isArray(data) && data.length) {
    data.forEach(m => addMeterRow(m));
  } else {
    addMeterRow(); // start with one blank row
  }
}

/* --- Photos & Documents (localStorage) --- */
let _photos = []; // {id,name,dataUrl,desc}
let _docs   = []; // {id,name,dataUrl}

const PHOTOS_LIMIT = 12;
const IMG_MAX_MB   = 1.2; // guard to keep localStorage happy
const PDF_MAX_MB   = 3.5;

function uid(){ return 'id' + Math.random().toString(36).slice(2,9) + Date.now().toString(36); }

function updatePhotosJson(){
  $('#photosJson').value = JSON.stringify(_photos);
}
function updateDocsJson(){
  $('#docsJson').value = JSON.stringify(_docs);
}

function renderPhotos(){
  const wrap = $('#photosList');
  wrap.innerHTML = '';
  _photos.forEach(p => {
    const card = document.createElement('div');
    card.className = 'photo-card';
    card.dataset.id = p.id;
    card.innerHTML = `
      <img class="photo-thumb" src="${p.dataUrl}" alt="${p.name}">
      <div class="photo-body">
        <input placeholder="Description‚Ä¶" value="${p.desc || ''}" class="photo-desc" />
        <button type="button" class="btn xs danger remove-photo">‚úï</button>
      </div>
    `;
    wrap.appendChild(card);
  });
}

function renderDocs(){
  const ul = $('#docsList');
  ul.innerHTML = '';
  _docs.forEach(d => {
    const li = document.createElement('li');
    li.className = 'doc-item';
    li.dataset.id = d.id;
    li.innerHTML = `
      <span class="doc-name">üìÑ ${d.name}</span>
      <button type="button" class="btn xs danger remove-doc">Delete</button>
    `;
    ul.appendChild(li);
  });
}

function fileToDataUrl(file){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function handlePhotosSelected(files){
  const arr = Array.from(files || []);
  for (const f of arr) {
    if (!f.type.startsWith('image/')) { showToast('Only images allowed'); continue; }
    const mb = f.size / (1024*1024);
    if (mb > IMG_MAX_MB) { showToast(`Image too large (> ${IMG_MAX_MB} MB): ${f.name}`); continue; }
    if (_photos.length >= PHOTOS_LIMIT) { showToast('Photo limit reached'); break; }
    const dataUrl = await fileToDataUrl(f);
    _photos.push({ id: uid(), name: f.name, dataUrl, desc: '' });
  }
  renderPhotos(); updatePhotosJson(); saveDraft();
}

async function handleDocsSelected(files){
  const arr = Array.from(files || []);
  for (const f of arr) {
    if (f.type !== 'application/pdf') { showToast('PDF only'); continue; }
    const mb = f.size / (1024*1024);
    if (mb > PDF_MAX_MB) { showToast(`PDF too large (> ${PDF_MAX_MB} MB): ${f.name}`); continue; }
    const dataUrl = await fileToDataUrl(f);
    _docs.push({ id: uid(), name: f.name, dataUrl });
  }
  renderDocs(); updateDocsJson(); saveDraft();
}

function hydrateMediaFromHidden(){
  try { _photos = JSON.parse($('#photosJson').value || '[]') || []; } catch{ _photos = []; }
  try { _docs   = JSON.parse($('#docsJson').value   || '[]') || []; } catch{ _docs   = []; }
  renderPhotos(); renderDocs();
}

function updatePrintAppendix(){
  const cont = $('#printAppendix');
  cont.innerHTML = '';
  // PDFs appendix only (no photo appendix)
  _docs.forEach((d) => {
    const wrap = document.createElement('div');
    wrap.className = 'page-break';
    wrap.innerHTML = `<h3>Document: ${d.name}</h3><iframe src="${d.dataUrl}" style="width:100%;height:1000px;border:0"></iframe>`;
    cont.appendChild(wrap);
  });
}


    function updateDmVisibility(){
  const sel  = document.getElementById('decisionMakerSelect');
  const wrap = document.getElementById('dmNameWrap');
  const inp  = document.getElementById('dmNameInput');
  if (!sel || !wrap || !inp) return;

  const v = (sel.value || '').toLowerCase();   // supports "false" or "no"
  const show = (v === 'false' || v === 'no');
  wrap.classList.toggle('hidden', !show);
  inp.disabled = !show;
  if (!show) inp.value = '';
}

    
    function validateMinimal(){
      const d=serializeForm($('#al-form'));
      const hasEmail=!!(d.client?.email), hasPhone=!!(d.client?.phone);
      const need=['staff.name','staff.meetingDate','client.company','client.rep'];
      for(const p of need){
        const parts=p.split('.'); let cur=d;
        for(const s of parts){ if(cur && typeof cur==='object' && s in cur) cur=cur[s]; else return false; }
        if(!cur) return false;
      }
      if(!hasEmail && !hasPhone) return false;
      return true;
    }
    function goStep(n){
      $$('.step').forEach(b=>b.classList.toggle('is-active', b.dataset.step==n));
      $$('.step-pane').forEach(p=>p.classList.toggle('is-active', p.dataset.stepPane==n));
      if(n==7) buildReview();
      window.scrollTo({top:0,behavior:'smooth'});
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      $('#year').textContent=new Date().getFullYear();
      loadDraft();
      buildMetersUIFromHidden();
      updateDmVisibility();
      updateAreaVisibility();



      $$('#steps .step').forEach(btn=>btn.addEventListener('click',()=>goStep(btn.dataset.step)));
      $$('.next').forEach(b=>b.addEventListener('click',()=>{ saveDraft(); const cur=Number($('.step.is-active').dataset.step); goStep(Math.min(cur+1,7)); }));
      $$('.prev').forEach(b=>b.addEventListener('click',()=>{ saveDraft(); const cur=Number($('.step.is-active').dataset.step); goStep(Math.max(cur-1,1)); }));

      $$('#al-form input,#al-form select,#al-form textarea').forEach(el=>{
        el.addEventListener('change', saveDraft);
        el.addEventListener('input', ()=>{
          if(el.dataset._typing) return; el.dataset._typing='1';
          setTimeout(()=>{ saveDraft(); delete el.dataset._typing; }, 500);
        });
      });

// Meters repeater events
$('#addMeterBtn').addEventListener('click', () => {
  addMeterRow();
  updateMetersJson();
  saveDraft();
});

$('#metersList').addEventListener('change', (e) => {
  const row = e.target.closest('.meter-row');
  if (!row) return;
  if (e.target.matches('.meter-type')) {
    const isCustom = e.target.value === '__custom__';
    const custom = row.querySelector('.meter-type-custom');
    custom.classList.toggle('hidden', !isCustom);
    if (isCustom) custom.focus();
  }
  updateMetersJson();
  saveDraft();
});

$('#metersList').addEventListener('input', (e) => {
  if (e.target.closest('.meter-row')) {
    updateMetersJson();
  }
});

$('#metersList').addEventListener('click', (e) => {
  const btn = e.target.closest('.remove-meter');
  if (!btn) return;
  btn.closest('.meter-row').remove();
  updateMetersJson();
  saveDraft();
});

// Photos input
$('#filePhotos').addEventListener('change', async (e) => {
  await handlePhotosSelected(e.target.files);
  e.target.value = '';
});
// Photo list events (desc/edit/delete)
$('#photosList').addEventListener('input', (e) => {
  const card = e.target.closest('.photo-card');
  if (!card) return;
  if (e.target.classList.contains('photo-desc')) {
    const id = card.dataset.id;
    const p = _photos.find(x => x.id === id); if (!p) return;
    p.desc = e.target.value;
    updatePhotosJson(); saveDraft();
  }
});
$('#photosList').addEventListener('click', (e) => {
  const btn = e.target.closest('.remove-photo');
  if (!btn) return;
  const card = btn.closest('.photo-card');
  const id = card.dataset.id;
  _photos = _photos.filter(x => x.id !== id);
  renderPhotos(); updatePhotosJson(); saveDraft();
});

// Docs input
$('#fileDocs').addEventListener('change', async (e) => {
  await handleDocsSelected(e.target.files);
  e.target.value = '';
});
$('#docsList').addEventListener('click', (e) => {
  const btn = e.target.closest('.remove-doc');
  if (!btn) return;
  const li = btn.closest('.doc-item');
  const id = li.dataset.id;
  _docs = _docs.filter(x => x.id !== id);
  renderDocs(); updateDocsJson(); saveDraft();
});

      
      $('#areaSelect').addEventListener('change', updateAreaVisibility);
      $('#consentChk').addEventListener('change', ()=>$('#submitBtn').disabled=!$('#consentChk').checked);

$('#printBtn').addEventListener('click', () => {
  buildReview();
  updatePrintAppendix(); // add photos + PDFs as printable appendix
  setTimeout(() => window.print(), 60);
});

    $('#resetBtn').addEventListener('click', () => {
  if (!confirm('Clear the form and remove saved draft?')) return;
  $('#al-form').reset();
  clearDraft();
  updateAreaVisibility();
  // reset meters
  $('#metersList').innerHTML = '';
  $('#metersJson').value = '[]';
  addMeterRow();
  showToast('Form reset');
});

// Decision Maker -> show box when "No"
const dmSel = document.getElementById('decisionMakerSelect');
if (dmSel) {
  dmSel.addEventListener('change', () => {
    updateDmVisibility();
    saveDraft();
  });
}


// Interests -> show "Others" box if selected
const interestsSel = $('#interests');
const otherWrap = $('#interestsOtherWrap');
const otherInput = $('#interestsOtherInput');
interestsSel.addEventListener('change', () => {
  const values = Array.from(interestsSel.selectedOptions).map(o => o.value);
  const show = values.includes('Others');
  otherWrap.classList.toggle('hidden', !show);
  otherInput.disabled = !show;
  if (!show) otherInput.value = '';
  saveDraft();
});



      
      $('#al-form').addEventListener('submit', (e)=>{
        e.preventDefault();
        if(!$('#consentChk').checked) return showToast('Please confirm the consent checkbox');
        if(!validateMinimal()) return showToast('Fill required fields: Staff, Date, Company, Rep, and Email/Phone.');
        const data=serializeForm($('#al-form'));
        console.log('[SUBMIT UI ONLY]', data);
        showToast('Saved locally. Backend wiring to MongoDB coming soon.');
      });
    });
  </script>
  <!-- Printable appendix for PDFs -->
<div id="printAppendix" class="print-only"></div>

</body>
</html>
