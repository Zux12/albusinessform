
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asianloop — Marketing & Business Dev Form</title>
  <link rel="icon" href="public/favicon.ico" />
  <link rel="stylesheet" href="public/css/styles.css" />
</head>
<body>
  <header class="al-header">
    <div class="al-inner">
      <div class="brand-left">
        <img src="public/logo-light.png" alt="Asianloop" class="brand-logo" />
        <span class="brand-title">Marketing &amp; Business Dev Form</span>
      </div>
      <div class="brand-right">
        <div class="avatar" title="Logged-in user (to be wired later)">AL</div>
      </div>
    </div>
  </header>

  <main class="al-main">
    <!-- Sticky Progress -->
    <nav id="steps" class="steps">
      <button class="step is-active" data-step="1">1. Staff &amp; Visit</button>
      <button class="step" data-step="2">2. Client</button>
      <button class="step" data-step="3">3. Opportunity</button>
      <button class="step" data-step="4">4. Tech Details</button>
      <button class="step" data-step="5">5. Timeline</button>
      <button class="step" data-step="6">6. Attach &amp; Notes</button>
      <button class="step" data-step="7">7. Review</button>
    </nav>

    <!-- Form -->
    <form id="al-form" class="al-form" autocomplete="on">
      <!-- 1) Staff & Visit -->
      <section class="card step-pane is-active" data-step-pane="1">
        <h2>Staff &amp; Visit</h2>
        <div class="grid-2">
          <label class="field">
            <span>Unit ID</span>
            <input name="staff.unitId" placeholder="S001" />
          </label>
          <label class="field">
            <span>Staff Name</span>
            <input name="staff.name" placeholder="Your name" />
          </label>
          <label class="field">
            <span>Date of Meeting</span>
            <input type="date" name="staff.meetingDate" />
          </label>
          <label class="field">
            <span>Visit Type</span>
            <select name="staff.visitType">
              <option value="">Select…</option>
              <option>In-person</option>
              <option>Virtual</option>
              <option>Phone</option>
            </select>
          </label>
        </div>

        <div class="grid-3">
          <label class="field">
            <span>Area</span>
            <select name="staff.region.area" id="areaSelect">
              <option value="">Select…</option>
              <option>Local</option>
              <option>International</option>
            </select>
          </label>
          <label class="field show-when-local hidden" id="localRegionWrap">
            <span>Local Region</span>
            <select name="staff.region.local">
              <option value="">Select…</option>
              <option>Northern</option>
              <option>Southern</option>
              <option>East Coast</option>
              <option>West Malaysia</option>
              <option>Borneo (Sabah/Sarawak)</option>
            </select>
          </label>
          <label class="field show-when-intl hidden" id="intlRegionWrap">
            <span>International Region</span>
            <select name="staff.region.international">
              <option value="">Select…</option>
              <option>ASEAN</option>
              <option>Middle East</option>
              <option>China</option>
              <option>Russia</option>
              <option>Europe</option>
              <option>North America</option>
            </select>
          </label>
        </div>

        <div class="actions">
          <button type="button" class="btn next">Next</button>
        </div>
      </section>

      <!-- 2) Client -->
      <section class="card step-pane" data-step-pane="2">
        <h2>Client</h2>
        <div class="grid-2">
          <label class="field">
            <span>Company</span>
            <input name="client.company" list="companyList" placeholder="Start typing…" />
            <datalist id="companyList">
              <option value="PETRONAS Carigali (PMA)">
              <option value="PETRONAS Gas Berhad (PGB)">
              <option value="MRCSB">
              <option value="Shell Malaysia">
              <option value="ExxonMobil Malaysia">
            </datalist>
          </label>
          <label class="field">
            <span>Customer Representative</span>
            <input name="client.rep" placeholder="Person you met" />
          </label>
          <label class="field">
            <span>Position/Role</span>
            <input name="client.position" placeholder="e.g., Maintenance Manager" />
          </label>
          <label class="field">
            <span>Email</span>
            <input type="email" name="client.email" placeholder="name@company.com" />
          </label>
          <label class="field">
            <span>Phone / WhatsApp</span>
            <input name="client.phone" placeholder="+60…" />
          </label>
          <label class="field">
            <span>Industry</span>
            <select name="client.industry">
              <option value="">Select…</option>
              <option>O&amp;G</option>
              <option>GI</option>
              <option>Chemical</option>
              <option>Utility</option>
              <option>Other</option>
            </select>
          </label>
        </div>
        <label class="field">
          <span>Address / Site (optional)</span>
          <input name="client.address" placeholder="Site/location" />
        </label>

        <div class="actions">
          <button type="button" class="btn ghost prev">Back</button>
          <button type="button" class="btn next">Next</button>
        </div>
      </section>

      <!-- 3) Opportunity -->
      <section class="card step-pane" data-step-pane="3">
        <h2>Opportunity</h2>
        <div class="grid-3">
          <label class="field">
            <span>Priority</span>
            <select name="opportunity.priority" id="prioritySelect">
              <option value="">Select…</option>
              <option value="1">P1 (Highest)</option>
              <option value="2">P2</option>
              <option value="3">P3</option>
              <option value="4">P4</option>
              <option value="5">P5</option>
            </select>
          </label>
          <label class="field">
            <span>Stage</span>
            <select name="opportunity.stage">
              <option value="">Select…</option>
              <option>Lead</option>
              <option>Qualified</option>
              <option>Proposal</option>
              <option>Negotiation</option>
              <option>Won</option>
              <option>Lost</option>
            </select>
          </label>
          <label class="field">
            <span>Estimated Budget</span>
            <input type="number" step="0.01" name="opportunity.budget" placeholder="Amount (MYR/USD)" />
          </label>
        </div>

        <div class="grid-2">
          <label class="field">
            <span>Decision Maker Identified?</span>
            <select name="opportunity.decisionMaker">
              <option value="">Select…</option>
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </label>
          <label class="field">
            <span>Procurement Route</span>
            <select name="opportunity.procurement">
              <option value="">Select…</option>
              <option>Direct</option>
              <option>Tender</option>
              <option>Panel</option>
              <option>Framework</option>
            </select>
          </label>
        </div>

        <label class="field">
          <span>Products / Services Interest</span>
          <select name="opportunity.interests" id="interests" multiple>
            <option>Flow calibration</option>
            <option>Custody metering</option>
            <option>Provers</option>
            <option>Analyzer services</option>
            <option>Training</option>
            <option>Compliance (API/OIML/ISO)</option>
            <option>Maintenance contracts</option>
          </select>
          <small class="hint">Use Ctrl/⌘ + click to multi-select.</small>
        </label>

        <label class="field">
          <span>Standards / Compliance</span>
          <select name="opportunity.standards" id="standards" multiple>
            <option>API MPMS 5.x</option>
            <option>API MPMS 21.1</option>
            <option>OIML R-117</option>
            <option>ISO 17025</option>
            <option>SIRIM</option>
            <option>DOE CAR2014</option>
            <option>BOMBA</option>
            <option>AELB</option>
          </select>
          <small class="hint">Use Ctrl/⌘ + click to multi-select.</small>
        </label>

        <div class="actions">
          <button type="button" class="btn ghost prev">Back</button>
          <button type="button" class="btn next">Next</button>
        </div>
      </section>

      <!-- 4) Tech Details -->
      <section class="card step-pane" data-step-pane="4">
        <h2>Tech Details (Optional)</h2>
        <div class="grid-3">
          <label class="field">
            <span>Flow Meter Type</span>
            <select name="tech.meterType">
              <option value="">Select…</option>
              <option>Ultrasonic</option>
              <option>Coriolis</option>
              <option>Turbine</option>
              <option>Positive Displacement</option>
              <option>Orifice</option>
              <option>Vortex</option>
              <option>Other</option>
            </select>
          </label>
          <label class="field">
            <span>Flow Meter Size (in)</span>
            <input type="number" step="0.1" name="tech.meterSizeIn" placeholder="e.g., 12" />
          </label>
          <label class="field">
            <span>Medium</span>
            <select name="tech.medium">
              <option value="">Select…</option>
              <option>Crude</option>
              <option>Condensate</option>
              <option>NGL</option>
              <option>LNG</option>
              <option>Gas</option>
              <option>Water</option>
              <option>Chemical</option>
            </select>
          </label>
        </div>

        <label class="field">
          <span>Operating Conditions</span>
          <input name="tech.conditions" placeholder="Pressure, temperature…" />
        </label>
        <label class="field">
          <span>Current Measurement Issues</span>
          <textarea name="tech.issues" rows="3" placeholder="Drift, repeatability, prover availability…"></textarea>
        </label>
        <label class="field">
          <span>Required Certs / Docs</span>
          <input name="tech.requiredDocs" placeholder="ISO17025 CoC, As-Found/As-Left, TP/LP…" />
        </label>

        <div class="actions">
          <button type="button" class="btn ghost prev">Back</button>
          <button type="button" class="btn next">Next</button>
        </div>
      </section>

      <!-- 5) Timeline & Next Actions -->
      <section class="card step-pane" data-step-pane="5">
        <h2>Timeline &amp; Next Actions</h2>
        <div class="grid-3">
          <label class="field">
            <span>Expected Timeline</span>
            <input name="timeline.expected" placeholder="e.g., 2025-Q4 or Nov 2025" />
          </label>
          <label class="field">
            <span>Next Follow-Up Date</span>
            <input type="date" name="timeline.nextFollowUp" />
          </label>
          <label class="field">
            <span>Follow-Up Status</span>
            <select name="timeline.followUpStatus">
              <option value="">Select…</option>
              <option>Pending</option>
              <option>Done</option>
              <option>Rescheduled</option>
            </select>
          </label>
        </div>

        <div class="grid-2">
          <label class="field">
            <span>Owner</span>
            <input name="timeline.owner" placeholder="Defaults to submitter later" />
          </label>
          <label class="field">
            <span>Task (optional)</span>
            <input name="timeline.task1" placeholder="e.g., Send capability deck — 28 Sep" />
          </label>
        </div>

        <div class="actions">
          <button type="button" class="btn ghost prev">Back</button>
          <button type="button" class="btn next">Next</button>
        </div>
      </section>

      <!-- 6) Attachments & Notes -->
      <section class="card step-pane" data-step-pane="6">
        <h2>Attachments &amp; Notes</h2>
        <div class="grid-2">
          <label class="field">
            <span>Business Card Photo</span>
            <input type="file" id="fileCard" disabled />
            <small class="hint">Uploads coming soon — click the button below to simulate.</small>
          </label>
          <label class="field">
            <span>RFI / RFP / NDA</span>
            <input type="file" id="fileRfp" disabled />
            <small class="hint">Uploads coming soon — click the button below to simulate.</small>
          </label>
        </div>

        <div class="actions-row">
          <button type="button" class="btn subtle" id="simulateUpload">Simulate Upload</button>
        </div>

        <label class="field">
          <span>Internal Notes</span>
          <textarea name="notes" rows="4" placeholder="Context for manager (internal only)…"></textarea>
        </label>

        <div class="actions">
          <button type="button" class="btn ghost prev">Back</button>
          <button type="button" class="btn next">Next</button>
        </div>
      </section>

      <!-- 7) Review & Submit -->
      <section class="card step-pane" data-step-pane="7">
        <h2>Review &amp; Submit</h2>
        <div id="review" class="review"></div>

        <label class="consent">
          <input type="checkbox" id="consentChk" />
          <span>I confirm the information provided is accurate to the best of my knowledge.</span>
        </label>

        <div class="actions">
          <button type="button" class="btn ghost prev">Back</button>
          <button type="button" class="btn" id="printBtn">Print Summary</button>
          <button type="submit" class="btn primary" id="submitBtn" disabled>Submit</button>
          <button type="button" class="btn danger" id="resetBtn">Reset</button>
        </div>
      </section>
    </form>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <footer class="al-footer">
    <div class="al-inner">
      <small>© <span id="year"></span> Asianloop — Internal use for Marketing &amp; Business Dev</small>
    </div>
  </footer>

  <script>
    // --- Helpers ---
    const $ = (q, ctx=document) => ctx.querySelector(q);
    const $$ = (q, ctx=document) => Array.from(ctx.querySelectorAll(q));
    const STORAGE_KEY = 'albusinessforms.draft';

    function showToast(msg) {
      const t = $('#toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 1800);
    }

    function objSet(obj, path, value) {
      const parts = path.split('.');
      let cur = obj;
      for (let i=0; i<parts.length-1; i++) {
        const k = parts[i];
        if (!(k in cur)) cur[k] = {};
        cur = cur[k];
      }
      cur[parts[parts.length-1]] = value;
    }

    function serializeForm(form) {
      const data = {};
      $$('input, select, textarea', form).forEach(el => {
        if (!el.name) return;
        if (el.type === 'checkbox') {
          objSet(data, el.name || el.id, el.checked);
        } else if (el.multiple && el.options) {
          const vals = Array.from(el.options).filter(o => o.selected).map(o => o.value);
          objSet(data, el.name, vals);
        } else {
          objSet(data, el.name, el.value);
        }
      });
      return data;
    }

    function fillForm(form, data) {
      if (!data) return;
      $$('input, select, textarea', form).forEach(el => {
        const path = el.name || el.id;
        if (!path) return;
        // Resolve path
        const parts = path.split('.');
        let cur = data;
        for (const p of parts) {
          if (cur && typeof cur === 'object' && p in cur) cur = cur[p];
          else { cur = undefined; break; }
        }
        if (cur === undefined) return;
        if (el.type === 'checkbox') {
          el.checked = !!cur;
        } else if (el.multiple && Array.isArray(cur)) {
          Array.from(el.options).forEach(o => o.selected = cur.includes(o.value));
        } else {
          el.value = cur;
        }
      });
    }

    function saveDraft() {
      const data = serializeForm($('#al-form'));
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      $('#submitBtn').disabled = !$('#consentChk').checked; // keep submit gated
      // no toast on every keystroke to avoid noise
    }

    function loadDraft() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        fillForm($('#al-form'), data);
        showToast('Draft loaded');
        updateAreaVisibility();
      } catch {}
    }

    function clearDraft() {
      localStorage.removeItem(STORAGE_KEY);
    }

    function priorityTag(p) {
      const map = { '1':'p1', '2':'p2', '3':'p3', '4':'p4', '5':'p5' };
      const label = { '1':'P1', '2':'P2', '3':'P3', '4':'P4', '5':'P5' }[p] || 'P?';
      const cls = map[p] || 'p5';
      return `<span class="priority ${cls}">${label}</span>`;
    }

    function buildReview() {
      const d = serializeForm($('#al-form'));
      const interests = (d.opportunity?.interests || []).join(', ') || '—';
      const standards = (d.opportunity?.standards || []).join(', ') || '—';
      const dm = d.opportunity?.decisionMaker === 'true' ? 'Yes' :
                 d.opportunity?.decisionMaker === 'false' ? 'No' : '—';

      $('#review').innerHTML = `
        <div class="review-grid">
          <div>
            <h3>Staff & Visit</h3>
            <ul>
              <li><strong>Unit ID:</strong> ${d.staff?.unitId || '—'}</li>
              <li><strong>Staff:</strong> ${d.staff?.name || '—'}</li>
              <li><strong>Meeting Date:</strong> ${d.staff?.meetingDate || '—'}</li>
              <li><strong>Visit Type:</strong> ${d.staff?.visitType || '—'}</li>
              <li><strong>Area:</strong> ${d.staff?.region?.area || '—'}</li>
              <li><strong>Local:</strong> ${d.staff?.region?.local || '—'}</li>
              <li><strong>International:</strong> ${d.staff?.region?.international || '—'}</li>
            </ul>
          </div>
          <div>
            <h3>Client</h3>
            <ul>
              <li><strong>Company:</strong> ${d.client?.company || '—'}</li>
              <li><strong>Rep:</strong> ${d.client?.rep || '—'}</li>
              <li><strong>Position:</strong> ${d.client?.position || '—'}</li>
              <li><strong>Email:</strong> ${d.client?.email || '—'}</li>
              <li><strong>Phone:</strong> ${d.client?.phone || '—'}</li>
              <li><strong>Industry:</strong> ${d.client?.industry || '—'}</li>
              <li><strong>Address:</strong> ${d.client?.address || '—'}</li>
            </ul>
          </div>
          <div>
            <h3>Opportunity ${priorityTag(d.opportunity?.priority || '')}</h3>
            <ul>
              <li><strong>Stage:</strong> ${d.opportunity?.stage || '—'}</li>
              <li><strong>Budget:</strong> ${d.opportunity?.budget || '—'}</li>
              <li><strong>Decision Maker:</strong> ${dm}</li>
              <li><strong>Procurement:</strong> ${d.opportunity?.procurement || '—'}</li>
              <li><strong>Interests:</strong> ${interests}</li>
              <li><strong>Standards:</strong> ${standards}</li>
            </ul>
          </div>
          <div>
            <h3>Tech</h3>
            <ul>
              <li><strong>Meter Type:</strong> ${d.tech?.meterType || '—'}</li>
              <li><strong>Size (in):</strong> ${d.tech?.meterSizeIn || '—'}</li>
              <li><strong>Medium:</strong> ${d.tech?.medium || '—'}</li>
              <li><strong>Conditions:</strong> ${d.tech?.conditions || '—'}</li>
              <li><strong>Issues:</strong> ${d.tech?.issues || '—'}</li>
              <li><strong>Required Docs:</strong> ${d.tech?.requiredDocs || '—'}</li>
            </ul>
          </div>
          <div>
            <h3>Timeline</h3>
            <ul>
              <li><strong>Expected:</strong> ${d.timeline?.expected || '—'}</li>
              <li><strong>Next Follow-Up:</strong> ${d.timeline?.nextFollowUp || '—'}</li>
              <li><strong>Status:</strong> ${d.timeline?.followUpStatus || '—'}</li>
              <li><strong>Owner:</strong> ${d.timeline?.owner || '—'}</li>
              <li><strong>Task:</strong> ${d.timeline?.task1 || '—'}</li>
            </ul>
          </div>
          <div>
            <h3>Notes</h3>
            <div class="notes-box">${(d.notes || '').replace(/</g,'&lt;') || '—'}</div>
          </div>
        </div>
      `;
    }

    function updateAreaVisibility() {
      const val = $('#areaSelect').value;
      $('#localRegionWrap').classList.toggle('hidden', val !== 'Local');
      $('#intlRegionWrap').classList.toggle('hidden', val !== 'International');
    }

    function validateMinimal() {
      const reqs = [
        'staff.name',
        'staff.meetingDate',
        'client.company',
        'client.rep',
        // at least one contact
      ];
      const data = serializeForm($('#al-form'));
      const hasEmail = !!(data.client?.email);
      const hasPhone = !!(data.client?.phone);
      for (const p of reqs) {
        const parts = p.split('.');
        let cur = data;
        for (const part of parts) {
          if (cur && typeof cur === 'object' && part in cur) cur = cur[part];
          else return false;
        }
        if (!cur) return false;
      }
      if (!hasEmail && !hasPhone) return false;
      return true;
    }

    // --- Step logic ---
    function goStep(n) {
      $$('.step').forEach(b => b.classList.toggle('is-active', b.dataset.step == n));
      $$('.step-pane').forEach(p => p.classList.toggle('is-active', p.dataset.stepPane == n));
      if (n == 7) buildReview();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Wire events
    document.addEventListener('DOMContentLoaded', () => {
      // Year
      $('#year').textContent = new Date().getFullYear();

      // Load draft (if available)
      loadDraft();

      // Step buttons (top)
      $$('#steps .step').forEach(btn => {
        btn.addEventListener('click', () => goStep(btn.dataset.step));
      });

      // Prev/Next
      $$('.next').forEach(b => b.addEventListener('click', () => {
        saveDraft();
        const cur = Number($('.step.is-active').dataset.step);
        goStep(Math.min(cur + 1, 7));
      }));
      $$('.prev').forEach(b => b.addEventListener('click', () => {
        saveDraft();
        const cur = Number($('.step.is-active').dataset.step);
        goStep(Math.max(cur - 1, 1));
      }));

      // Autosave on change
      $$('#al-form input, #al-form select, #al-form textarea').forEach(el => {
        el.addEventListener('change', saveDraft);
        el.addEventListener('input', e => {
          // Throttle lightweightly
          if (el.dataset._typing) return;
          el.dataset._typing = '1';
          setTimeout(() => { saveDraft(); delete el.dataset._typing; }, 600);
        });
      });

      // Area toggles
      $('#areaSelect').addEventListener('change', updateAreaVisibility);

      // Consent gating submit
      $('#consentChk').addEventListener('change', () => {
        $('#submitBtn').disabled = !$('#consentChk').checked;
      });

      // Simulate upload
      $('#simulateUpload').addEventListener('click', () => {
        showToast('Uploads coming soon — this feature will be enabled in v1.1');
      });

      // Print
      $('#printBtn').addEventListener('click', () => {
        buildReview();
        window.print();
      });

      // Reset
      $('#resetBtn').addEventListener('click', () => {
        if (!confirm('Clear the form and remove saved draft?')) return;
        $('#al-form').reset();
        clearDraft();
        updateAreaVisibility();
        showToast('Form reset');
      });

      // Submit (UI only)
      $('#al-form').addEventListener('submit', (e) => {
        e.preventDefault();
        if (!$('#consentChk').checked) {
          showToast('Please confirm the consent checkbox');
          return;
        }
        if (!validateMinimal()) {
          showToast('Please complete required fields (Staff, Date, Company, Rep, and Email/Phone).');
          return;
        }
        const data = serializeForm($('#al-form'));
        console.log('[SUBMIT UI ONLY]', data);
        showToast('Saved locally. Backend wiring to MongoDB coming soon.');
      });
    });
  </script>
</body>
</html>
